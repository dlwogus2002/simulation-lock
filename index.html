<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œë®¬ë ˆì´ì…˜ ì ìœ  í˜„í™©</title>
    <style>
        body { font-family: sans-serif; background: #f5f7fa; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 2.5rem 2rem; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 380px; text-align: center; }
        .badge { padding: 8px 18px; border-radius: 50px; font-weight: bold; display: inline-block; margin-bottom: 20px; font-size: 14px; }
        .free { background: #e3f2fd; color: #1976d2; }
        .busy { background: #fff1f2; color: #e11d48; }
        .user-list { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; }
        .user-item { border: 1px solid #eee; padding: 12px; border-radius: 12px; cursor: pointer; }
        .user-item.selected { border: 2px solid #e11d48; background: #fff1f2; color: #e11d48; font-weight: bold; }
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; font-weight: bold; }
        .btn-in { background: #e11d48; color: white; }
        .btn-out { background: #e11d48; color: white; margin-top: 15px; }
        .time-box { background: #f8fafc; padding: 15px; border-radius: 12px; margin: 15px 0; font-size: 14px; color: #475569; text-align: left; border: 1px solid #f1f5f9; }
        .timer-val { color: #e11d48; font-weight: bold; font-size: 16px; float: right; }
        .warning { color: #f43f5e; font-size: 12px; margin-top: 15px; font-weight: bold; display: block; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="card">
    <div id="statusBadge" class="badge free">âœ… ì‚¬ìš© ê°€ëŠ¥</div>
    <h2 id="statusTitle">í˜„ì¬ ë¹„ì–´ìˆìŒ</h2>

    <div id="timeDisplay" class="time-box hidden">
        <div style="margin-bottom:8px;">ğŸ“… ì ‘ì† ì‹œê°„: <span id="startTimeText" style="font-weight:600;">-</span></div>
        <div>â³ ê²½ê³¼ ì‹œê°„: <span id="durationText" class="timer-val">0ì‹œê°„ 0ë¶„ 0ì´ˆ</span></div>
    </div>

    <div id="loginArea">
        <p style="color: #666; font-size: 14px;">ëˆ„ê°€ ì‚¬ìš©í•˜ì‹œë‚˜ìš”?</p>
        <div class="user-list">
            <div class="user-item" onclick="sel('ì¬í˜„')">ì¬í˜„</div>
            <div class="user-item" onclick="sel('í˜„ìš°')">í˜„ìš°</div>
            <div class="user-item" onclick="sel('ì„¸í˜•')">ì„¸í˜•</div>
            <div class="user-item" onclick="sel('ì§€ì˜')">ì§€ì˜</div>
        </div>
        <button id="inBtn" class="btn-in" onclick="connect()" disabled>ì ‘ì†í•˜ê¸°</button>
    </div>

    <div id="logoutArea" class="hidden">
        <button class="btn-out" onclick="disconnect()">ì ‘ì† ì¢…ë£Œ</button>
        <span class="warning">âš ï¸ ë³¸ì¸ ì™¸ì— ëˆ„ë¥´ì§€ ë§ˆì„¸ìš”</span>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        databaseURL: "https://simapp-a2c75-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'simulation/status'); // ê²½ë¡œë¥¼ ëª…í™•íˆ ì§€ì •

    let myName = "";
    let interval = null;

    window.sel = (name) => {
        myName = name;
        document.querySelectorAll('.user-item').forEach(el => el.classList.toggle('selected', el.innerText === name));
        document.getElementById('inBtn').disabled = false;
    };

    window.connect = () => {
        // í˜„ì¬ ë¡œì»¬ ì‹œê°„ë„ ë°±ì—…ìš©ìœ¼ë¡œ í•¨ê»˜ ì €ì¥
        set(dbRef, { 
            user: myName, 
            active: true, 
            startTime: serverTimestamp(),
            localStartTime: Date.now() 
        });
    };

    window.disconnect = () => {
        if(confirm("ì ‘ì†ì„ ì¢…ë£Œí• ê¹Œìš”?")) {
            set(dbRef, { user: "", active: false, startTime: null });
        }
    };

    function startTimer(startMillis) {
        if (interval) clearInterval(interval);
        const update = () => {
            const diff = Date.now() - startMillis;
            const h = Math.floor(diff / 3600000);
            const m = Math.floor((diff % 3600000) / 60000);
            const s = Math.floor((diff % 60000) / 1000);
            document.getElementById('durationText').innerText = `${h}ì‹œê°„ ${m}ë¶„ ${s}ì´ˆ`;
        };
        interval = setInterval(update, 1000);
        update();
    }

    onValue(dbRef, (snap) => {
        const data = snap.val();
        const timeDisplay = document.getElementById('timeDisplay');
        const loginArea = document.getElementById('loginArea');
        const logoutArea = document.getElementById('logoutArea');

        if (data && data.active) {
            document.getElementById('statusBadge').className = "badge busy";
            document.getElementById('statusBadge').innerText = "ğŸš¨ ì ‘ì† ì¤‘";
            document.getElementById('statusTitle').innerText = data.user + " ë‹˜ì´ ì‚¬ìš© ì¤‘";
            
            loginArea.classList.add('hidden');
            logoutArea.classList.remove('hidden');
            timeDisplay.classList.remove('hidden');

            // ì„œë²„ ì‹œê°„(startTime)ì´ ì•„ì§ ë„ì°© ì•ˆ í–ˆìœ¼ë©´ ë¡œì»¬ ì‹œê°„(localStartTime) ì‚¬ìš©
            const timeSource = data.startTime || data.localStartTime;
            if (timeSource) {
                document.getElementById('startTimeText').innerText = new Date(timeSource).toLocaleTimeString();
                startTimer(timeSource);
            }
        } else {
            if (interval) clearInterval(interval);
            document.getElementById('statusBadge').className = "badge free";
            document.getElementById('statusBadge').innerText = "âœ… ì‚¬ìš© ê°€ëŠ¥";
            document.getElementById('statusTitle').innerText = "í˜„ì¬ ë¹„ì–´ìˆìŒ";
            loginArea.classList.remove('hidden');
            logoutArea.classList.add('hidden');
            timeDisplay.classList.add('hidden');
            document.getElementById('inBtn').disabled = true;
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('selected'));
        }
    });
</script>

</body>
</html>
