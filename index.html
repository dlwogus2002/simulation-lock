<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>툴 사용 현황</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; margin:0; padding:24px; }
    .wrap { max-width: 520px; margin: 0 auto; }
    h1 { font-size: 20px; margin: 0 0 16px; }
    .card { border: 1px solid #ddd; border-radius: 12px; padding: 16px; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    label { display:flex; gap:8px; align-items:center; padding:10px 12px; border:1px solid #eee; border-radius: 10px; cursor:pointer; }
    button { width:100%; margin-top:12px; padding:12px; border-radius:10px; border:1px solid #ccc; cursor:pointer; font-size:16px; }
    button.primary { border-color:#111; }
    .muted { color:#666; font-size: 13px; margin-top:10px; }
    .status { margin-top: 12px; padding: 12px; border-radius: 10px; background: #f7f7f7; }
    .danger { background:#fff1f1; border:1px solid #ffd0d0; }
    .ok { background:#f1fff3; border:1px solid #c9ffd1; }
    .small { font-size: 12px; color:#555; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>시뮬레이션 툴 사용 현황</h1>
    <div class="card">
      <div id="view-select">
        <div class="row" id="name-options">
          <!-- checkboxes injected -->
        </div>
        <button class="primary" id="btn-connect">접속</button>
        <div class="muted">한 번에 한 사람만 “접속중”으로 표시됩니다.</div>
      </div>

      <div id="view-using" style="display:none;">
        <div class="status ok" id="using-text"></div>
        <button id="btn-disconnect">접속 종료</button>
        <div class="small" id="since-text"></div>
      </div>

      <div class="status danger" id="lock-info" style="display:none;"></div>
    </div>
  </div>

  <!-- Firebase (v10+) -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
    import { getDatabase, ref, onValue, runTransaction, set, remove, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-database.js";

    // TODO: 여기를 너 Firebase 프로젝트 설정으로 교체
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const NAMES = ["지영", "현우", "재현", "세형"];

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    const lockRef = ref(db, "lock");

    const viewSelect = document.getElementById("view-select");
    const viewUsing = document.getElementById("view-using");
    const nameOptions = document.getElementById("name-options");
    const btnConnect = document.getElementById("btn-connect");
    const btnDisconnect = document.getElementById("btn-disconnect");
    const usingText = document.getElementById("using-text");
    const sinceText = document.getElementById("since-text");
    const lockInfo = document.getElementById("lock-info");

    // UI state
    let selectedName = null;
    let currentLock = null;
    const mySessionKey = "my_lock_name";
    const myName = localStorage.getItem(mySessionKey);

    // Build checkboxes (single-select behavior)
    function renderOptions() {
      nameOptions.innerHTML = "";
      NAMES.forEach((n) => {
        const id = "cb_" + n;
        const label = document.createElement("label");
        label.innerHTML = `
          <input type="checkbox" id="${id}" />
          <span>${n}</span>
        `;
        const cb = label.querySelector("input");
        cb.addEventListener("change", (e) => {
          if (e.target.checked) {
            // uncheck others
            [...nameOptions.querySelectorAll("input")].forEach(x => { if (x !== cb) x.checked = false; });
            selectedName = n;
          } else {
            selectedName = null;
          }
        });

        // if we had previous selection
        if (myName === n) {
          cb.checked = true;
          selectedName = n;
        }

        nameOptions.appendChild(label);
      });
    }

    renderOptions();

    function showSelect() {
      viewSelect.style.display = "";
      viewUsing.style.display = "none";
    }
    function showUsing(name, sinceMs) {
      viewSelect.style.display = "none";
      viewUsing.style.display = "";
      usingText.textContent = `${name} 접속중`;
      if (sinceMs) {
        const d = new Date(sinceMs);
        sinceText.textContent = `시작: ${d.toLocaleString("ko-KR")}`;
      } else {
        sinceText.textContent = "";
      }
    }

    // Listen lock changes for everyone
    onValue(lockRef, (snap) => {
      currentLock = snap.val(); // {name, since}
      if (!currentLock) {
        lockInfo.style.display = "none";
        // If I thought I was using, reset
        if (localStorage.getItem(mySessionKey)) {
          // keep name selection but show select screen
          showSelect();
        }
        return;
      }

      const name = currentLock.name;
      const since = currentLock.since;

      // If it's me, show using screen
      if (localStorage.getItem(mySessionKey) === name) {
        lockInfo.style.display = "none";
        showUsing(name, since);
      } else {
        // someone else is using
        lockInfo.style.display = "";
        lockInfo.textContent = `현재 ${name} 사용중입니다. (다른 사람은 접속할 수 없음)`;
        showSelect();
      }
    });

    // Acquire lock atomically
    btnConnect.addEventListener("click", async () => {
      if (!selectedName) {
        alert("이름을 하나 선택해줘.");
        return;
      }

      // Transaction: set lock if empty
      try {
        const result = await runTransaction(lockRef, (curr) => {
          if (curr === null) {
            return { name: selectedName, since: Date.now() };
          }
          return; // abort
        });

        if (!result.committed) {
          alert(`이미 ${result.snapshot.val()?.name ?? "다른 사람"}이(가) 사용중이야.`);
          return;
        }

        localStorage.setItem(mySessionKey, selectedName);
        showUsing(selectedName, Date.now());
      } catch (e) {
        console.error(e);
        alert("접속 처리 중 오류가 발생했어.");
      }
    });

    // Release lock (only if it's mine)
    btnDisconnect.addEventListener("click", async () => {
      const mine = localStorage.getItem(mySessionKey);
      if (!mine) {
        // just reset UI
        showSelect();
        return;
      }

      // Transaction: remove only if lock holder matches me
      try {
        const result = await runTransaction(lockRef, (curr) => {
          if (curr && curr.name === mine) return null; // remove
          return; // abort
        });

        localStorage.removeItem(mySessionKey);

        // Reset checkboxes selection
        selectedName = null;
        renderOptions();
        showSelect();

        if (!result.committed) {
          alert("이미 다른 상태로 변경되어서 종료 처리할 수 없었어.");
        }
      } catch (e) {
        console.error(e);
        alert("접속 종료 중 오류가 발생했어.");
      }
    });
  </script>
</body>
</html>
