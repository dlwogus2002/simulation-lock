<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹œë®¬ë ˆì´ì…˜ ì ìœ  í˜„í™©</title>
    <style>
        body { font-family: sans-serif; background: #f5f7fa; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .card { background: white; padding: 2.5rem 2rem; border-radius: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); width: 380px; text-align: center; }
        .badge { padding: 8px 18px; border-radius: 50px; font-weight: bold; display: inline-block; margin-bottom: 25px; font-size: 14px; }
        .free { background: #e3f2fd; color: #1976d2; }
        .busy { background: #fff1f2; color: #e11d48; }
        .user-list { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 20px 0; }
        .user-item { border: 1px solid #eee; padding: 12px; border-radius: 12px; cursor: pointer; transition: 0.2s; }
        .user-item.selected { border: 2px solid #e11d48; background: #fff1f2; color: #e11d48; font-weight: bold; }
        button { width: 100%; padding: 15px; border: none; border-radius: 12px; font-size: 16px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-in { background: #e11d48; color: white; }
        .btn-out { background: #e11d48; color: white; margin-top: 15px; }
        .time-info { background: #f8fafc; padding: 15px; border-radius: 12px; margin: 20px 0; font-size: 14px; color: #64748b; line-height: 1.6; }
        .timer-highlight { color: #e11d48; font-weight: bold; font-size: 16px; }
        .warning-text { color: #f43f5e; font-size: 13px; margin-top: 15px; font-weight: bold; display: block; }
        .hidden { display: none; }
    </style>
</head>
<body>

<div class="card">
    <div id="statusBadge" class="badge free">âœ… ì‚¬ìš© ê°€ëŠ¥</div>
    <h2 id="statusTitle" style="margin-bottom: 10px;">í˜„ì¬ ë¹„ì–´ìˆìŒ</h2>

    <div id="timeDisplay" class="time-info hidden">
        <div>ì ‘ì† ì‹œê°„: <span id="startTimeText">-</span></div>
        <div style="margin-top: 5px;">í˜„ì¬ <span id="durationText" class="timer-highlight">0ì‹œê°„ 0ë¶„ 0ì´ˆ</span> ì§¸ ì‚¬ìš© ì¤‘</div>
    </div>

    <div id="loginArea">
        <p style="color: #666;">ëˆ„ê°€ ì‚¬ìš©í•˜ì‹œë‚˜ìš”?</p>
        <div class="user-list">
            <div class="user-item" onclick="sel('ì¬í˜„')">ì¬í˜„</div>
            <div class="user-item" onclick="sel('í˜„ìš°')">í˜„ìš°</div>
            <div class="user-item" onclick="sel('ì„¸í˜•')">ì„¸í˜•</div>
            <div class="user-item" onclick="sel('ì§€ì˜')">ì§€ì˜</div>
        </div>
        <button id="inBtn" class="btn-in" onclick="connect()" disabled>ì ‘ì†í•˜ê¸°</button>
    </div>

    <div id="logoutArea" class="hidden">
        <button class="btn-out" onclick="disconnect()">ì ‘ì† ì¢…ë£Œ</button>
        <span class="warning-text">âš ï¸ ë³¸ì¸ ì™¸ì— ëˆ„ë¥´ì§€ ë§ˆì„¸ìš”</span>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getDatabase, ref, set, onValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

    const firebaseConfig = {
        databaseURL: "https://simapp-a2c75-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const dbRef = ref(db, 'room/status');

    let myName = "";
    let timerInterval = null;

    window.sel = (name) => {
        myName = name;
        document.querySelectorAll('.user-item').forEach(el => el.classList.toggle('selected', el.innerText === name));
        document.getElementById('inBtn').disabled = false;
    };

    window.connect = () => {
        // serverTimestampë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ì˜ ì •í™•í•œ ì‹œê°„ì„ ê¸°ë¡í•©ë‹ˆë‹¤.
        set(dbRef, { 
            user: myName, 
            active: true, 
            startTime: serverTimestamp() 
        });
    };

    window.disconnect = () => {
        if(confirm("ì •ë§ë¡œ ì ‘ì†ì„ ì¢…ë£Œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
            set(dbRef, { user: "", active: false, startTime: null });
        }
    };

    // ê²½ê³¼ ì‹œê°„ ê³„ì‚° í•¨ìˆ˜
    function updateTimer(startMillis) {
        const now = Date.now();
        const diff = now - startMillis;

        const hours = Math.floor(diff / (1000 * 60 * 60));
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secs = Math.floor((diff % (1000 * 60)) / 1000);

        document.getElementById('durationText').innerText = `${hours}ì‹œê°„ ${mins}ë¶„ ${secs}ì´ˆ`;
    }

    onValue(dbRef, (snap) => {
        const data = snap.val();
        const badge = document.getElementById('statusBadge');
        const title = document.getElementById('statusTitle');
        const loginArea = document.getElementById('loginArea');
        const logoutArea = document.getElementById('logoutArea');
        const timeDisplay = document.getElementById('timeDisplay');
        
        // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ì§€
        if (timerInterval) clearInterval(timerInterval);

        if (data && data.active) {
            badge.innerText = "ğŸš¨ ì ‘ì† ì¤‘";
            badge.className = "badge busy";
            title.innerText = data.user + " ë‹˜ì´ ì‚¬ìš© ì¤‘ì…ë‹ˆë‹¤.";
            
            loginArea.classList.add('hidden');
            logoutArea.classList.remove('hidden');
            timeDisplay.classList.remove('hidden');

            if (data.startTime) {
                const startDate = new Date(data.startTime);
                document.getElementById('startTimeText').innerText = startDate.toLocaleString();
                
                // 1ì´ˆë§ˆë‹¤ íƒ€ì´ë¨¸ ì—…ë°ì´íŠ¸
                timerInterval = setInterval(() => updateTimer(data.startTime), 1000);
                updateTimer(data.startTime);
            }
        } else {
            badge.innerText = "âœ… ì‚¬ìš© ê°€ëŠ¥";
            badge.className = "badge free";
            title.innerText = "í˜„ì¬ ë¹„ì–´ìˆìŒ";
            loginArea.classList.remove('hidden');
            logoutArea.classList.add('hidden');
            timeDisplay.classList.add('hidden');
            
            myName = "";
            document.querySelectorAll('.user-item').forEach(el => el.classList.remove('selected'));
            document.getElementById('inBtn').disabled = true;
        }
    });
</script>

</body>
</html>
